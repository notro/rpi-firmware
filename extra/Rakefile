=begin

rpi-firmware release
--------------------

WORKDIR=workdir.bcm2708 LINUX_DEFCONFIG=bcmrpi_defconfig  rpi-build tinydrm clean log build
WORKDIR=workdir.bcm2709 LINUX_DEFCONFIG=bcm2709_defconfig rpi-build tinydrm clean log build

rpi-build tinydrm merge install SSHIP=192.168.10.120

rpi-build tinydrm commit
rpi-build tinydrm push


=end

require 'stdlib/rpi-linux'



# tools are already unpacked
ENV['CROSS_COMPILE'] = '/home/pi/tools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian/bin/arm-linux-gnueabihf-'



release :tinydrm => [:rpi_linux_common, :tinydrm_kernel, :linux_headers] do
  ENV['COMMIT_MESSAGE'] = "4.10.4"
  VAR['RASPBERRYPI_LINUX_BRANCH'] ||= 'rpi-4.10.y'
  VAR['FW_BRANCH'] ||= 'tinydrm'

  Readme.desc { "Raspberry Pi kernels #{VAR['KERNEL_RELEASE']} with [tinydrm](https://github.com/notro/tinydrm/wiki) support including kernel headers." }

  Readme.defconfig = 'bcmrpi_defconfig and bcm2709_defconfig'

#  Readme.body = """
#Changelog
#---------
##{Time.now.strftime('%Y-%m-%d')}
#*
#
#2015-07-11
#* Update to 4.0.7 @ [13f82f4](https://github.com/raspberrypi/linux/commit/151dc845f920bb8f38abc0a6fc89093a913f82f4)
#
#"""
end


package :tinydrm_kernel do

  patch '0001-drm-Store-a-pointer-to-drm_format_info-under-drm_fra.patch'
  patch '0002-drm-cma-helper-simplify-setup-for-drivers-with-dirty.patch'
  patch '0003-drm-fb-cma-helper-Add-drm_fbdev_cma_set_suspend_unlo.patch'
  patch '0004-drm-debugfs-Remove-all-files-automatically-on-cleanu.patch'
  patch '0005-drm-simple-helpers-Add-missing-includes.patch'
  patch '0006-drm-Rely-on-mode_config-data-for-fb_helper-initializ.patch'
  patch '0007-drm-Add-DRM-support-for-tiny-LCD-displays.patch'
  patch '0008-drm-tinydrm-Add-helper-functions.patch'
  patch '0009-drm-tinydrm-Add-MIPI-DBI-support.patch'
  patch '0010-drm-tinydrm-Add-support-for-Multi-Inno-MI0283QT-disp.patch'
  patch '0011-drm-tinydrm-mipi-dbi-Silence-cmd-may-be-used-uniniti.patch'
  patch '0012-drm-tinydrm-mipi-dbi-Fix-field-width-specifier-warni.patch'
  patch '0013-drm-tinydrm-helpers-Properly-fix-backlight-dependenc.patch'
  patch '0014-drm-tinydrm-fix-semicolon.cocci-warnings.patch'

  target :patch do
    fn = workdir('linux/drivers/gpu/drm/tinydrm/core/tinydrm-helpers.c')
    s = File.read fn
    File.write fn, "#define DEBUG\n" + s
    Readme.patch "* Build tinydrm-helpers.c with DEBUG to get SPI transfer details\n"
  end

  target :patch do
    rpi_display = 'https://raw.githubusercontent.com/notro/tinydrm/master/rpi-overlays/rpi-display-overlay.dts'
    sh "wget #{rpi_display} -O #{workdir('linux/arch/arm/boot/dts/overlays/rpi-display-overlay.dts')}"
    Readme.patch "* Use #{rpi_display}\n"

    pitft = 'https://raw.githubusercontent.com/notro/tinydrm/master/rpi-overlays/pitft28-resistive-overlay.dts'
    sh "wget #{pitft} -O #{workdir('linux/arch/arm/boot/dts/overlays/pitft28-resistive-overlay.dts')}"
    Readme.patch "* Use #{pitft}\n"
  end

  config ['CONFIG_IKCONFIG', 'CONFIG_IKCONFIG_PROC'], :enable

  config ['DRM_TINYDRM'], :module
  config ['TINYDRM_MI0283QT'], :module

#  config ['FB_TFT'], :disable
#  config ['FB_SSD1307'], :disable

  target :build do
    cp Rake.application.rakefile, workdir('out/extra/')
  end
end

def linux_header_script(srcdir, dstdir)
  script = %{#!/bin/sh

set -e

srctree=#{srcdir}
objtree=$srctree
SRCARCH=arm
KCONFIG_CONFIG=$srctree/.config
kernel_headers_dir=#{dstdir}
version=ref

mkdir -p $objtree/debian

# Copied from scripts/package/builddeb (Linux 4.11)
# Start VERBATIM
# Escaped \*

# Build kernel header package
(cd $srctree; find . -name Makefile\\* -o -name Kconfig\\* -o -name \\*.pl) > "$objtree/debian/hdrsrcfiles"
(cd $srctree; find arch/*/include include scripts -type f) >> "$objtree/debian/hdrsrcfiles"
(cd $srctree; find arch/$SRCARCH -name module.lds -o -name Kbuild.platforms -o -name Platform) >> "$objtree/debian/hdrsrcfiles"
(cd $srctree; find $(find arch/$SRCARCH -name include -o -name scripts -type d) -type f) >> "$objtree/debian/hdrsrcfiles"
if grep -q '^CONFIG_STACK_VALIDATION=y' $KCONFIG_CONFIG ; then
	(cd $objtree; find tools/objtool -type f -executable) >> "$objtree/debian/hdrobjfiles"
fi
(cd $objtree; find arch/$SRCARCH/include Module.symvers include scripts -type f) >> "$objtree/debian/hdrobjfiles"
if grep -q '^CONFIG_GCC_PLUGINS=y' $KCONFIG_CONFIG ; then
	(cd $objtree; find scripts/gcc-plugins -name \\*.so -o -name gcc-common.h) >> "$objtree/debian/hdrobjfiles"
fi
destdir=$kernel_headers_dir/usr/src/linux-headers-$version
mkdir -p "$destdir"
(cd $srctree; tar -c -f - -T -) < "$objtree/debian/hdrsrcfiles" | (cd $destdir; tar -xf -)
(cd $objtree; tar -c -f - -T -) < "$objtree/debian/hdrobjfiles" | (cd $destdir; tar -xf -)
(cd $objtree; cp $KCONFIG_CONFIG $destdir/.config) # copy .config manually to be where it's expected to be

# End VERBATIM

# make modules_prepare has to be run on the host to rebuild the tools

# make prepare
(cd $srctree; find arch/$SRCARCH/tools -type f) > "$objtree/debian/extrafiles"

# make scripts
(cd $srctree; find tools/include/tools -type f) >> "$objtree/debian/extrafiles"

(cd $objtree; tar -c -f - -T -) < "$objtree/debian/extrafiles" | (cd $destdir; tar -xf -)

rm -r $objtree/debian

}

  fn = workdir('linux-headers')
  File.open(fn, 'w') { |file| file.write script }
  sh "chmod +x #{fn}"
  fn
end

package :linux_headers do

  # post_install is additive and cleared in kbuild
  target :kbuild do
    post_install %q[
find "${FW_REPOLOCAL}/modules" -mindepth 1 -maxdepth 1 -type d | while read DIR; do
	BASEDIR=$(basename "${DIR}")
	echo "     Preparing kernel headers ${BASEDIR}"
	(cd ${FW_MODPATH}/${BASEDIR}/build; make modules_prepare)
done
]
  end

  target :external do
    script = linux_header_script(workdir('linux'), workdir('headers'))
    sh "#{script}"
    File.write workdir('headers/usr/src/linux-headers-ref/.scmversion') , '+'
  end

  target :build do
    rel = VAR['KERNEL_RELEASE']
    src = workdir('headers/usr/src/linux-headers-ref/.')
    build = workdir("out/modules/#{rel}/build")

    rm workdir("out/modules/#{rel}/source")
    rm build

    mkdir build
    sh "cp -r #{src} #{build}"
  end

end
